name: Greathost-AutoRenew-PY

on:
  schedule:
    - cron: '0 */12 * * *'  # æ¯12å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è¿è¡Œ

jobs:
  Auto_renew_greathost:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 2. å®‰è£… Chrome æµè§ˆå™¨ (Selenium-Wire éœ€è¦)
      - name: Install Google Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      # 3. å®‰è£…ä¾èµ–
      # æ³¨æ„ï¼šå¿…é¡»å®‰è£… selenium-wire, blinker(ç‰¹å®šç‰ˆæœ¬é˜²æŠ¥é”™), requests
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium==4.18.1 selenium-wire==5.1.0 blinker==1.7.0 requests

      # 4. è¿è¡Œ Python è„šæœ¬
      - name: Run renew script
        env:
          GREATHOST_EMAIL: ${{ secrets.GREATHOST_EMAIL }}
          GREATHOST_PASSWORD: ${{ secrets.GREATHOST_PASSWORD }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.CHAT_ID }}    
          PROXY_URL: ${{ secrets.PROXY_URL }}
        run: python greathost.py

      # 5. ä¸Šä¼ è°ƒè¯•æˆªå›¾ (å¦‚æœè„šæœ¬é‡Œæœ‰ save_screenshot çš„è¯)
      - name: Upload Error Page
        if: failure() # ä»…åœ¨è„šæœ¬æŠ¥é”™å¤±è´¥æ—¶æ‰§è¡Œ
        uses: actions/upload-artifact@v4
        with:
          name: error-screenshot
          path: error_page.html
          retention-days: 3 # ä¿å­˜3å¤©

      - name: ğŸ§¹ æ¸…ç†æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
        uses: MajorScruffy/delete-old-workflow-runs@v0.3.0
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          repository: ${{ github.repository }}
          older-than-seconds: 3600  # åˆ é™¤1å°æ—¶å‰çš„è®°å½•   
